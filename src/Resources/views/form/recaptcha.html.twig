{# @Recaptcha/form/recaptcha.html.twig #}

{% block recaptcha_widget %}
    {% apply spaceless %}
        <div id="{{ id }}" data-toggle="recaptcha" data-type="{{ type }}">
        </div>
        <script type="text/javascript">
          function onGoogleReCaptchaApiLoad() {
            const widgets = document.querySelectorAll("[data-toggle=\"recaptcha\"]");

            for (let i = 0; i < widgets.length; i++) {
              renderReCaptcha(widgets[i]);
            }
          }

          function renderReCaptcha(widget) {
            const form = widget.closest("form");
            const widgetType = widget.getAttribute("data-type");

            const widgetParameters = {
              "sitekey": '{{ google_site_key }}',
            };

            if (widgetType === "invisible") {
              widgetParameters["callback"] = function () {
                form.submit();
              };
              widgetParameters["size"] = "invisible";
            }

            const widgetId = grecaptcha.render(widget, widgetParameters);
            if (widgetType === "invisible") {
              bindChallengeToSubmitButtons(form, widgetId);
            }
          }

          function bindChallengeToSubmitButtons(form, reCaptchaId) {
            getSubmitButtons(form).forEach(function (button) {
              button.addEventListener("click", function (e) {
                e.preventDefault();
                grecaptcha.execute(reCaptchaId);
              });
            });
          }

          function getSubmitButtons(form) {
            const buttons = form.querySelectorAll("button, input");
            const submitButtons = [];

            for (let i = 0; i < buttons.length; i++) {
              const button = buttons[i];
              if (button.getAttribute("type") === "submit") {
                submitButtons.push(button);
              }
            }

            return submitButtons;
          }
        </script>
        <script type="text/javascript" src="https://www.google.com/recaptcha/api.js?onload=onGoogleReCaptchaApiLoad&render=explicit&hl={{ app.request.locale }}" async defer></script>
    {% endapply %}
{% endblock %}
